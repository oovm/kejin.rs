难道现在不是叠层触发的吗, 不然攒刀是个什么原理?

---





设 $p$ 为目标概率, $a$ 为实际概率, 函数 $P(a)$ 表示实际概率为 $a$ 时, 期望的攒刀次数, 函数 $A(p)$ 表示目标概率为 $p$ 时, 期望的攒刀次数, 则有

假设 $a = 0.3$, 则有

| 次数  | 触发概率  | 独立概率                              | PDF     | CDF     | 期望      |
|:---:|-------|-----------------------------------|:--------|---------|---------|
|  1  | `0.3` | `0.3`                             | `0.300` | `0.300` | `0.300` |
|  2  | `0.6` | `(1 - 0.3) × 0.6`                 | `0.420` | `0.720` | `0.840` |
|  3  | `0.9` | `(1 - 0.3)(1 - 0.6) × 0.9`        | `0.252` | `0.972` | `0.756` |
|  4  | `1.0` | `(1 - 0.3)(1 - 0.6)(1 - 0.9) × 1` | `0.048` | `1.000` | `0.112` |
| 5~∞ | `0.0` | `0`                               | `0.000` | `1.000` | `0.000` |

于是目标概率 $p$ 就是

$$
p = (0.3 + 0.84 + 0.756 + 0.112)^{-1}= 49.8\%
$$

这一结果记为 $P(30\%) = 49.8\%$, 或者说 $A(49.8\%) = 30\%$.

总结一下这个过程, 可以得到公式:

$$
P(a)=\left(\sum_{n=1}^{\left⌊1/a\right⌋  } \left(n⋅\prod _{i=0}^{n-1} (1-a i)⋅an\right)
+\left(\left\lfloor \frac{1}{a}\right\rfloor +1\right)\prod _{i=0}^{\left⌊1/a\right⌋ } (1-a i)\right)^{-1}
$$

但是我们要求的是他的反函数 $A(p)$, 得先展开这一大坨得到连续解析形式:

$$
\begin{aligned}
P(a) &= \frac{a}{\phi+\varphi}\\
\phi &= \frac{e^{1/a} E\left(-\frac{a+1}{a},\frac{1}{a}\right)-a (a+2)}{a+1}\\
\varphi &= \frac{(-a)^{\left\lfloor \frac{1}{a}\right\rfloor } \left(a \left(\left\lfloor \frac{1}{a}\right\rfloor  \left(a \left\lfloor \frac{1}{a}\right\rfloor +2 a-1\right)+a\right)-e^{1/a} E\left(\left\lfloor \frac{1}{a}\right\rfloor -\frac{1}{a}+1,\frac{1}{a}\right)\right) \Gamma \left(\left\lfloor \frac{1}{a}\right\rfloor -\frac{1}{a}+1\right)}{\Gamma \left(\frac{a-1}{a}\right)}
\end{aligned}
$$

然后在原点做级数反演就能得到:

$$
A(p)≈k-\sqrt{k^2-144} + O(p^{-5/2}), k=\dfrac{16}{\pi}\left(\dfrac{3}{p}+1\right)^2-12
$$

实际实现可以打个表插值

| 目标概率 |   实际概率 |
|-----:|-------:|
|   0% |  0.00% |
|   1% |  0.02% |
|   2% |  0.06% |
|   3% |  0.14% |
|   4% |  0.24% |
|   5% |  0.38% |
|   6% |  0.54% |
|   7% |  0.74% |
|   8% |  0.96% |
|   9% |  1.20% |
|  10% |  1.47% |
|  15% |  3.22% |
|  20% |  5.57% |
|  25% |  8.47% |
|  30% | 11.89% |
|  35% | 15.80% |
|  40% | 20.15% |
|  45% | 24.93% |
|  50% | 30.21% |
|  55% | 36.04% |
|  60% | 42.26% |
|  65% | 48.11% |
|  70% | 57.14% |
|  75% | 66.67% |
|  80% | 75.00% |
|  85% | 82.35% |
|  90% | 88.89% |
|  95% | 94.74% |
| 100% | 100.0% |